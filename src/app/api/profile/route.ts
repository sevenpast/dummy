// ============================================================================
// PROFILE API - SIMPLIFIED & SECURED VERSION
// Optimized with upsert() and simplified logic
// ============================================================================

import { NextRequest, NextResponse } from 'next/server'
import { withAuth, AuthenticatedRequest } from '@/lib/auth/middleware'
import { withErrorHandling, createError } from '@/lib/error-handling'
import { ProfileUpdateSchema, validateRequestBody } from '@/lib/validation/schemas'
import { createClient } from '@/lib/supabase/server'

const profileHandler = async (request: AuthenticatedRequest): Promise<NextResponse> => {
  const user = request.user
  const userId = user.id

  // Create Supabase client with the authenticated user's token
  const authHeader = request.headers.get('authorization')
  const token = authHeader?.substring(7) // Remove 'Bearer '

  const supabase = await createClient()
  if (token) {
    await supabase.auth.setSession({ access_token: token, refresh_token: '' })
  }

  // SIMPLIFIED: Use .single() for cleaner code
  const { data, error } = await supabase
    .from('user_profiles')
    .select('*')
    .eq('user_id', userId)
    .single()

  if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
    throw createError.database('Failed to fetch profile', error)
  }

  return NextResponse.json({
    success: true,
    data: data || null
  })
}

const upsertProfileHandler = async (request: AuthenticatedRequest): Promise<NextResponse> => {
  const user = request.user
  const userId = user.id
  const body = await request.json()
  const profileData = validateRequestBody(ProfileUpdateSchema, body)

  // Create Supabase client with the authenticated user's token
  const authHeader = request.headers.get('authorization')
  const token = authHeader?.substring(7) // Remove 'Bearer '

  const supabase = await createClient()
  if (token) {
    await supabase.auth.setSession({ access_token: token, refresh_token: '' })
  }

  // SIMPLIFIED: Single upsert operation handles both create and update
  const { data, error } = await supabase
    .from('user_profiles')
    .upsert({
      user_id: userId,
      ...profileData,
      updated_at: new Date().toISOString()
    }, {
      onConflict: 'user_id'
    })
    .select()
    .single()

  if (error) {
    throw createError.database('Failed to save profile', error)
  }

  return NextResponse.json({
    success: true,
    data
  })
}

// SIMPLIFIED: Only two endpoints needed - GET and UPSERT
export const GET = withAuth(withErrorHandling(profileHandler))
export const POST = withAuth(withErrorHandling(upsertProfileHandler))
export const PUT = withAuth(withErrorHandling(upsertProfileHandler))